<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>–ö–æ—Ñ–µ—è–Ω–∞ —É –ê–Ω–¥—Ä–µ—è ‚Äî Mini App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1113; --card:#15181c; --stroke:#1f2328; --muted:#94a3b8; --text:#eaecee;
      --primary:#3b82f6; --chip:#30363d; --chip-active:#1e293b; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:12px;flex:1;min-width:300px}
    .badge{display:inline-block;background:#1f2937;color:#cbd5e1;border-radius:999px;padding:4px 8px;font-size:12px}
    .btn{border:1px solid var(--chip);background:#1f2328;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn.primary{border-color:transparent;background:var(--primary)}
    .line{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #242a32}
    .line:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    .chip{padding:8px 10px;border:1px solid var(--chip);border-radius:12px;text-align:center;cursor:pointer}
    .chip.active{border-color:var(--primary);background:var(--chip-active)}
    .qty{display:flex;align-items:center;gap:8px}
    .qty .btn{width:40px;height:40px}
    img.item{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:12px;border:1px solid var(--stroke);background:#0a0c0e}
    .mini{width:56px;height:40px;object-fit:cover;border-radius:8px;border:1px solid var(--stroke);background:#0a0c0e}
    .footer{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(15,17,19,0) 0%, var(--bg) 40%);padding-top:10px}
    /* toast */
    .toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#0b1210;border:1px solid #13321f;color:#d1fae5;padding:10px 14px;border-radius:12px;display:none;z-index:9999}
    .toast.show{display:block;animation:fade 2.2s ease}
    @keyframes fade{0%{opacity:0;transform:translate(-50%,-8px)}10%,90%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-8px)}}
  </style>
</head>
<body>
<div class="wrap">
  <div id="toast" class="toast">–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É ‚úÖ</div>

  <h1>–ö–æ—Ñ–µ—è–Ω–∞ —É –ê–Ω–¥—Ä–µ—è</h1>

  <div class="row">
    <div class="card" style="flex:1.2">
      <div class="badge">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
      <div class="row" style="margin:10px 0 12px">
        <button class="btn" onclick="selectCategory('coffee')">‚òï –ö–æ—Ñ–µ</button>
        <button class="btn" onclick="selectCategory('snacks')">ü•™ –ó–∞–∫—É—Å–∫–∏</button>
      </div>
      <div id="items"></div>
    </div>

    <div class="card" style="min-width:320px">
      <div class="badge">–ü–æ–∑–∏—Ü–∏—è</div>
      <div id="details" style="margin-top:10px" class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</div>
    </div>

    <div class="card" style="min-width:320px">
      <div class="badge">–ö–æ—Ä–∑–∏–Ω–∞</div>
      <div id="cartList" style="margin-top:10px"></div>
      <div id="cartTotal" style="margin-top:8px;font-weight:700;font-size:18px">–ò—Ç–æ–≥–æ: 0‚Ç∏</div>
      <div class="footer">
        <button class="btn primary" style="width:100%;padding:12px" onclick="sendOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== –†–µ–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (royalty-free) =====
  const IMAGES = {
    // –ö–æ—Ñ–µ
    "–≠—Å–ø—Ä–µ—Å—Å–æ": "https://upload.wikimedia.org/wikipedia/commons/4/45/A_small_cup_of_coffee.JPG",
    "–ê–º–µ—Ä–∏–∫–∞–Ω–æ": "https://images.unsplash.com/photo-1541167760496-1628856ab772?q=80&w=1200&auto=format&fit=crop",
    "–ö–∞–ø—É—á–∏–Ω–æ": "https://images.unsplash.com/photo-1503481766315-7a586b20f66b?q=80&w=1200&auto=format&fit=crop",
    "–õ–∞—Ç—Ç–µ": "https://images.unsplash.com/photo-1461988091159-192b6df7054f?q=80&w=1200&auto=format&fit=crop",
    "–§–ª—ç—Ç —É–∞–π—Ç": "https://images.unsplash.com/photo-1534687941688-651ccaafbff2?q=80&w=1200&auto=format&fit=crop",
    // –ó–∞–∫—É—Å–∫–∏
    "–ö—Ä—É–∞—Å—Å–∞–Ω": "https://images.unsplash.com/photo-1512058564366-18510be2db19?q=80&w=1200&auto=format&fit=crop",
    "–ß–∏–∑–∫–µ–π–∫": "https://images.unsplash.com/photo-1509358271058-acd22cc93898?q=80&w=1200&auto=format&fit=crop",
    "–ú–∞—Ñ—Ñ–∏–Ω —à–æ–∫–æ–ª–∞–¥–Ω—ã–π": "https://images.unsplash.com/photo-1588196749597-9ff075ee6b5b?q=80&w=1200&auto=format&fit=crop",
    "–°—ç–Ω–¥–≤–∏—á —Å –∏–Ω–¥–µ–π–∫–æ–π": "https://images.unsplash.com/photo-1550317138-10000687a72b?q=80&w=1200&auto=format&fit=crop",
  };

  // ===== –ú–µ–Ω—é / –æ–ø—Ü–∏–∏ =====
  const MENU = {
    coffee: [
      {name:"–≠—Å–ø—Ä–µ—Å—Å–æ", price:900},
      {name:"–ê–º–µ—Ä–∏–∫–∞–Ω–æ", price:1000},
      {name:"–ö–∞–ø—É—á–∏–Ω–æ", price:1300},
      {name:"–õ–∞—Ç—Ç–µ", price:1400},
      {name:"–§–ª—ç—Ç —É–∞–π—Ç", price:1500},
    ],
    snacks: [
      {name:"–ö—Ä—É–∞—Å—Å–∞–Ω", price:900},
      {name:"–ß–∏–∑–∫–µ–π–∫", price:1500},
      {name:"–ú–∞—Ñ—Ñ–∏–Ω —à–æ–∫–æ–ª–∞–¥–Ω—ã–π", price:800},
      {name:"–°—ç–Ω–¥–≤–∏—á —Å –∏–Ω–¥–µ–π–∫–æ–π", price:1700},
    ],
  };

  const SIZES = {
    s:{title:"S ‚Ä¢ 200 –º–ª", delta:0},
    m:{title:"M ‚Ä¢ 300 –º–ª", delta:200},
    l:{title:"L ‚Ä¢ 400 –º–ª", delta:400},
  };

  const ADDONS = [
    {title:"–î–æ–ø. —à–æ—Ç —ç—Å–ø—Ä–µ—Å—Å–æ", price:300},
    {title:"–ë–µ–∑–ª–∞–∫—Ç–æ–∑–Ω–æ–µ –º–æ–ª–æ–∫–æ", price:200},
    {title:"–°–∏—Ä–æ–ø –≤–∞–Ω–∏–ª—å", price:150},
    {title:"–°–∏—Ä–æ–ø –∫–∞—Ä–∞–º–µ–ª—å", price:150},
  ];

  // ===== State =====
  let state = {
    category: "coffee",
    selectedIdx: null,
    size: "m",
    addons: [],
    qty: 1,
    cart: []
  };

  const tg = window.Telegram?.WebApp;
  const money = x => `${x}‚Ç∏`;
  function calcUnitPrice(base, sizeKey, addIdx){
    let p = base;
    if (sizeKey) p += SIZES[sizeKey].delta;
    (addIdx||[]).forEach(i=>p+=ADDONS[i].price);
    return p;
  }
  function cartTotal(){ return state.cart.reduce((s,x)=>s+x.line_total,0); }
  function showToast(msg="–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É ‚úÖ"){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.remove("show");
    void t.offsetWidth; // reflow
    t.classList.add("show");
  }

  // ===== Catalog =====
  function selectCategory(cat){
    state.category = cat;
    state.selectedIdx = null;
    state.size = (cat==="coffee") ? "m" : null;
    state.addons = [];
    state.qty = 1;
    renderItems();
    renderDetails();
  }

  function renderItems(){
    const items = MENU[state.category] || [];
    const box = document.getElementById("items");
    if (!items.length){ box.innerHTML = "<div class='muted'>–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –ø—É—Å—Ç</div>"; return; }

    box.innerHTML = items.map((it, i)=>`
      <div class="line">
        <div style="display:flex;gap:10px;align-items:center">
          <img class="mini" src="${IMAGES[it.name]||'https://placehold.co/112x80'}" alt="${it.name}">
          <div>
            <div style="font-weight:600">${it.name}</div>
            <div class="muted">${money(it.price)}</div>
          </div>
        </div>
        <button class="btn" onclick="selectItem(${i})">–í—ã–±—Ä–∞—Ç—å</button>
      </div>
    `).join("");
  }

  function selectItem(idx){
    state.selectedIdx = idx;
    state.size = (state.category==="coffee") ? (state.size||"m") : null;
    state.addons = [];
    state.qty = 1;
    renderDetails();
  }

  // ===== Details =====
  function toggleSize(k){ state.size = k; renderDetails(); }
  function toggleAddon(i){
    const pos = state.addons.indexOf(i);
    if (pos>=0) state.addons.splice(pos,1); else state.addons.push(i);
    renderDetails();
  }
  function changeQty(d){ state.qty = Math.max(1,(state.qty||1)+d); renderDetails(); }

  function renderDetails(){
    const el = document.getElementById("details");
    const items = MENU[state.category] || [];
    if (state.selectedIdx===null || !items[state.selectedIdx]){
      el.innerHTML = "<div class='muted'>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</div>"; return;
    }
    const it = items[state.selectedIdx];
    const unit = calcUnitPrice(it.price, state.size, state.addons);

    const img = IMAGES[it.name] || "https://placehold.co/800x500";
    const sizes = (state.category==="coffee") ? `
      <div class="row" style="margin:10px 0">
        ${Object.keys(SIZES).map(k=>{
          const active = (state.size===k)?"chip active":"chip";
          return `<div class="${active}" onclick="toggleSize('${k}')">${SIZES[k].title}</div>`;
        }).join("")}
      </div>` : "";

    const addons = (state.category==="coffee" && ADDONS.length) ? `
      <div class="row" style="flex-wrap:wrap;margin:6px 0 10px">
        ${ADDONS.map((a,i)=>{
          const active = state.addons.includes(i)?"chip active":"chip";
          return `<div class="${active}" onclick="toggleAddon(${i})">${a.title} (+${a.price}‚Ç∏)</div>`;
        }).join("")}
      </div>` : "";

    el.innerHTML = `
      <img class="item" src="${img}" alt="${it.name}">
      <div style="margin-top:10px;font-weight:700">${it.name}</div>
      <div class="muted">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ${money(it.price)}</div>
      ${sizes}
      ${addons}
      <div class="qty" style="margin:8px 0 6px">
        <button class="btn" onclick="changeQty(-1)">‚Äì</button>
        <div>${state.qty}</div>
        <button class="btn" onclick="changeQty(1)">+</button>
      </div>
      <div style="margin:6px 0">–¶–µ–Ω–∞ –∑–∞ 1: <b>${money(unit)}</b></div>
      <button class="btn primary" style="width:100%;padding:10px" onclick="addToCart()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    `;
  }

  function addToCart(){
    const items = MENU[state.category] || [];
    if (state.selectedIdx===null || !items[state.selectedIdx]) return;
    const it = items[state.selectedIdx];
    const unit = calcUnitPrice(it.price, state.size, state.addons);

    const key = JSON.stringify({name:it.name, size:state.category==="coffee"?state.size:null, addons:[...state.addons].sort()});
    const found = state.cart.find(x=>x._key===key);
    if (found){
      found.qty += state.qty;
      found.line_total = found.unit_price * found.qty;
    }else{
      state.cart.push({
        _key:key,
        name: it.name,
        size: state.category==="coffee" ? state.size : null,
        addons: state.category==="coffee" ? state.addons.map(i=>ADDONS[i].title) : [],
        qty: state.qty,
        unit_price: unit,
        line_total: unit * state.qty,
        img: IMAGES[it.name] || "https://placehold.co/112x80"
      });
    }
    renderCart();
    try{ tg?.HapticFeedback?.impactOccurred?.("light"); }catch{}
  }

  // ===== Cart =====
  function removeFromCartIndex(i){
    if (i>=0 && i<state.cart.length){
      state.cart.splice(i,1);
      renderCart();
    }
  }

  function renderCart(){
    const box = document.getElementById("cartList");
    if (!state.cart.length){
      box.innerHTML = "<div class='muted'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
    }else{
      box.innerHTML = state.cart.map((x,i)=>{
        const opts = [];
        if (x.size) opts.push((x.size||"").toUpperCase());
        if (x.addons && x.addons.length) opts.push(...x.addons);
        const optText = opts.length?` <span class="muted">(${opts.join(", ")})</span>`:"";
        return `
          <div class="line">
            <div style="display:flex;gap:10px;align-items:center">
              <img class="mini" src="${x.img}" alt="">
              <div>
                <div style="font-weight:600">${x.name}${optText}</div>
                <div class="muted">x${x.qty} ‚Ä¢ ${money(x.unit_price)}</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div>${money(x.line_total)}</div>
              <button class="btn" title="–£–¥–∞–ª–∏—Ç—å" onclick="removeFromCartIndex(${i})">‚úñ</button>
            </div>
          </div>
        `;
      }).join("");
    }
    document.getElementById("cartTotal").innerText = "–ò—Ç–æ–≥–æ: " + money(cartTotal());
  }

  // ===== Send (–ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–∞–ø–∫—É) =====
  async function sendOrder(){
    if (!state.cart.length){ alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"); return; }

    const payload = {
      customer_name: "",
      phone: "",
      items: state.cart.map(({_key,img, ...rest})=>rest),
      total: cartTotal()
    };

    const insideTG = !!(tg && typeof tg.sendData === "function");
    if (insideTG){
      try{
        tg.HapticFeedback?.impactOccurred?.("light");
        tg.sendData(JSON.stringify(payload));     // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞
        state.cart = [];
        renderCart();
        showToast("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É ‚úÖ");     // –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–∫—Ä—ã—Ç–æ–π
      }catch(e){
        tg.showAlert && tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
      }
    }else{
      console.log("Payload preview:", payload);
      alert("–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–∞–ø–∫—É —á–µ—Ä–µ–∑ Telegram (–∫–Ω–æ–ø–∫–∞ —É –±–æ—Ç–∞). –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
    }
  }

  // ===== Init =====
  (function init(){
    try{ tg?.expand(); tg?.ready(); tg?.MainButton?.hide(); }catch{}
    selectCategory("coffee");
    renderItems(); renderDetails(); renderCart();
  })();
</script>
</body>
</html>
